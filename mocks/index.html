<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SocketChat Mock</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6',
                        secondary: '#1e40af',
                    }
                }
            }
        }
    </script>
    <style>
        /* Modern scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        ::-webkit-scrollbar-thumb {
            background: #888; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555; 
        }
    </style>
</head>
<body class="bg-gray-100 h-screen font-sans overflow-hidden text-gray-800">

    <!-- LOGIN MODAL -->
    <div id="login-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-xl shadow-2xl max-w-md w-full">
            <h2 class="text-2xl font-bold mb-6 text-center text-gray-800">SocketChat Login</h2>
            <p class="text-gray-600 mb-6 text-center">Select a user to simulate login:</p>
            <div class="grid grid-cols-1 gap-3">
                <button onclick="app.login('u1')" class="p-3 bg-blue-100 hover:bg-blue-200 rounded-lg flex items-center gap-3 transition">
                    <div class="w-10 h-10 rounded-full bg-blue-500 text-white flex items-center justify-center font-bold">A</div>
                    <div class="text-left">
                        <div class="font-bold">Alice</div>
                        <div class="text-xs text-blue-600">ID: u1</div>
                    </div>
                </button>
                <button onclick="app.login('u2')" class="p-3 bg-green-100 hover:bg-green-200 rounded-lg flex items-center gap-3 transition">
                    <div class="w-10 h-10 rounded-full bg-green-500 text-white flex items-center justify-center font-bold">B</div>
                    <div class="text-left">
                        <div class="font-bold">Bob</div>
                        <div class="text-xs text-green-600">ID: u2</div>
                    </div>
                </button>
                <button onclick="app.login('u3')" class="p-3 bg-purple-100 hover:bg-purple-200 rounded-lg flex items-center gap-3 transition">
                    <div class="w-10 h-10 rounded-full bg-purple-500 text-white flex items-center justify-center font-bold">C</div>
                    <div class="text-left">
                        <div class="font-bold">Charlie</div>
                        <div class="text-xs text-purple-600">ID: u3</div>
                    </div>
                </button>
                <button onclick="app.login('u4')" class="p-3 bg-yellow-100 hover:bg-yellow-200 rounded-lg flex items-center gap-3 transition">
                    <div class="w-10 h-10 rounded-full bg-yellow-500 text-white flex items-center justify-center font-bold">D</div>
                    <div class="text-left">
                        <div class="font-bold">David</div>
                        <div class="text-xs text-yellow-600">ID: u4</div>
                    </div>
                </button>
            </div>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="main-app" class="hidden flex h-full">
        <!-- SIDEBAR -->
        <div class="w-80 bg-white border-r border-gray-200 flex flex-col">
            <!-- User Profile Header -->
            <div class="p-4 border-b border-gray-200 bg-gray-50 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div id="current-user-avatar" class="w-10 h-10 rounded-full bg-gray-300 text-white flex items-center justify-center font-bold">U</div>
                    <div>
                        <div id="current-user-name" class="font-bold text-gray-800">User</div>
                        <div class="flex items-center gap-1 text-xs text-green-600">
                            <span class="w-2 h-2 bg-green-500 rounded-full"></span> Online
                        </div>
                    </div>
                </div>
                <button onclick="app.logout()" class="text-xs text-gray-500 hover:text-red-500 underline">Logout</button>
            </div>

            <!-- List Types -->
            <div class="p-2">
                <div class="flex gap-2 p-2 bg-gray-100 rounded-lg">
                    <button id="tab-direct" class="flex-1 py-1 px-3 bg-white shadow rounded text-sm font-semibold" onclick="app.switchTab('DIRECT')">Direct</button>
                    <button id="tab-group" class="flex-1 py-1 px-3 text-gray-500 hover:text-gray-700 text-sm font-semibold" onclick="app.switchTab('GROUP')">Groups</button>
                </div>
            </div>

            <!-- Conversations List -->
            <div id="conversation-list" class="flex-1 overflow-y-auto p-2 space-y-1">
                <!-- Items injected by JS -->
            </div>
        </div>

        <!-- CHAT AREA -->
        <div class="flex-1 flex flex-col bg-slate-50 relative">
            
            <!-- Chat Header -->
            <div class="h-16 bg-white border-b border-gray-200 flex items-center px-6 justify-between shadow-sm">
                <div class="flex items-center gap-3">
                    <div id="header-avatar" class="w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center text-gray-500">#</div>
                    <div>
                        <h3 id="header-title" class="font-bold text-lg text-gray-800">Select a chat</h3>
                        <p id="header-status" class="text-xs text-gray-500 h-4"></p>
                    </div>
                </div>
                <div class="flex gap-4">
                     <!-- Action buttons like Info, Call could go here -->
                </div>
            </div>

            <!-- Messages Area -->
            <div id="messages-container" class="flex-1 overflow-y-auto p-6 space-y-4">
                <div class="h-full flex flex-col items-center justify-center text-gray-400">
                    <svg class="w-16 h-16 mb-4 opacity-20" fill="currentColor" viewBox="0 0 20 20"><path d="M2 5a2 2 0 012-2h7a2 2 0 012 2v4a2 2 0 01-2 2H9l-3 3v-3H4a2 2 0 01-2-2V5z"></path><path d="M15 7v2a4 4 0 01-4 4H9.828l-1.766 1.767c.28.149.599.233.938.233h2l3 3v-3h2a2 2 0 012-2V9a2 2 0 01-2-2h-1z"></path></svg>
                    <p>Select a conversation to start chatting</p>
                </div>
            </div>

            <!-- Input Area -->
            <div class="p-4 bg-white border-t border-gray-200">
                <form onsubmit="app.sendMessage(event)" class="flex gap-2">
                    <input type="text" id="message-input" class="flex-1 border border-gray-300 rounded-full px-5 py-3 focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition shadow-sm" placeholder="Type a message..." disabled autocomplete="off">
                    <button type="submit" id="send-btn" class="bg-blue-600 hover:bg-blue-700 text-white rounded-full p-3 px-6 font-semibold transition disabled:opacity-50 disabled:cursor-not-allowed shadow-md flex items-center gap-2" disabled>
                        <span>Send</span>
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
                    </button>
                </form>
                <div class="text-center mt-2">
                     <p class="text-xs text-gray-400">Press Enter to send</p>
                </div>
            </div>

            <!-- Toast Notification -->
            <div id="toast" class="absolute top-4 right-4 bg-gray-800 text-white px-4 py-2 rounded shadow-lg transform transition translate-y-[-150%] opacity-0">
                Notification
            </div>
        </div>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // --- DATA & STATE ---
        const USERS = {
            'u1': { id: 'u1', name: 'Alice', avatarBg: 'bg-blue-500' },
            'u2': { id: 'u2', name: 'Bob', avatarBg: 'bg-green-500' },
            'u3': { id: 'u3', name: 'Charlie', avatarBg: 'bg-purple-500' },
            'u4': { id: 'u4', name: 'David', avatarBg: 'bg-yellow-500' }
        };

        const GROUPS = {
            'g1': { id: 'g1', name: 'Project Alpha', participants: ['u1', 'u2', 'u3'] },
            'g2': { id: 'g2', name: 'Lunch Buddies', participants: ['u1', 'u2', 'u4'] }
        };

        class AppState {
            constructor() {
                this.currentUser = null;
                this.activeTab = 'DIRECT'; // 'DIRECT' | 'GROUP'
                this.activeConversationId = null;
                
                // Simulated DB
                this.messages = {}; // conversationId: [Message]
                this.presence = {
                    'u1': 'OFFLINE', 'u2': 'OFFLINE', 'u3': 'OFFLINE', 'u4': 'OFFLINE'
                };
            }
        }

        const state = new AppState();

        // --- CORE APP CLASS ---
        class App {
            constructor() {
                this.ws = null;
            }

            login(userId) {
                state.currentUser = USERS[userId];
                
                // 1. UI Update
                document.getElementById('login-modal').classList.add('hidden');
                document.getElementById('main-app').classList.remove('hidden');
                
                this.updateCurrentUserUI();
                
                // 2. Simulate WebSocket Connection
                this.connectWebSocket();

                // 3. Render Lists
                this.renderSidebar();
            }

            logout() {
                // Disconnect WS
                if (this.ws) console.log('[WS] Disconnected');
                
                // Reset State (simplified)
                location.reload(); 
            }

            connectWebSocket() {
                console.log(`[WS] Connecting as ${state.currentUser.name} (ws://localhost:8080?userId=${state.currentUser.id})`);
                
                // Simulate Connection Delay
                setTimeout(() => {
                    this.showToast('Connected to Server');
                    state.presence[state.currentUser.id] = 'ONLINE';
                    
                    // Simulate receiving presence updates from others
                    this.startPresenceSimulation();
                }, 500);
            }

            startPresenceSimulation() {
                // Randomly flip other users online/offline every few seconds
                setInterval(() => {
                    const others = Object.keys(USERS).filter(id => id !== state.currentUser.id);
                    const randomUser = others[Math.floor(Math.random() * others.length)];
                    const newStatus = Math.random() > 0.3 ? 'ONLINE' : 'OFFLINE'; // Mostly online
                    
                    if (state.presence[randomUser] !== newStatus) {
                        state.presence[randomUser] = newStatus;
                        console.log(`[WS] Event: PRESENCE_UPDATE -> User ${randomUser} is ${newStatus}`);
                        this.renderSidebar(); // Re-render to show status
                        
                        // Update header if chatting with this user
                        if (state.activeConversationId === randomUser) {
                            this.updateHeaderStatus(randomUser);
                        }
                    }
                }, 5000);
            }

            updateCurrentUserUI() {
                const user = state.currentUser;
                document.getElementById('current-user-name').innerText = user.name;
                const avatar = document.getElementById('current-user-avatar');
                avatar.innerText = user.name[0];
                avatar.className = `w-10 h-10 rounded-full flex items-center justify-center font-bold text-white ${user.avatarBg}`;
            }

            switchTab(tab) {
                state.activeTab = tab;
                document.getElementById('tab-direct').className = tab === 'DIRECT' ? 'flex-1 py-1 px-3 bg-white shadow rounded text-sm font-semibold' : 'flex-1 py-1 px-3 text-gray-500 hover:text-gray-700 text-sm font-semibold';
                document.getElementById('tab-group').className = tab === 'GROUP' ? 'flex-1 py-1 px-3 bg-white shadow rounded text-sm font-semibold' : 'flex-1 py-1 px-3 text-gray-500 hover:text-gray-700 text-sm font-semibold';
                this.renderSidebar();
            }

            renderSidebar() {
                const container = document.getElementById('conversation-list');
                container.innerHTML = '';

                if (state.activeTab === 'DIRECT') {
                    Object.values(USERS).forEach(user => {
                        if (user.id === state.currentUser.id) return; // Don't list self

                        const isOnline = state.presence[user.id] === 'ONLINE';
                        const isActive = state.activeConversationId === user.id;

                        const el = document.createElement('button');
                        el.className = `w-full text-left p-3 rounded-lg flex items-center gap-3 hover:bg-gray-100 transition ${isActive ? 'bg-blue-50 ring-1 ring-blue-200' : ''}`;
                        el.onclick = () => this.openChat(user.id, 'DIRECT');
                        
                        el.innerHTML = `
                            <div class="relative">
                                <div class="w-10 h-10 rounded-full ${user.avatarBg} text-white flex items-center justify-center font-bold">${user.name[0]}</div>
                                <div class="absolute bottom-0 right-0 w-3 h-3 border-2 border-white rounded-full ${isOnline ? 'bg-green-500' : 'bg-gray-400'}"></div>
                            </div>
                            <div class="flex-1">
                                <div class="font-semibold text-gray-800">${user.name}</div>
                                <div class="text-xs text-gray-500 truncate">Click to chat</div>
                            </div>
                        `;
                        container.appendChild(el);
                    });
                } else {
                    Object.values(GROUPS).forEach(group => {
                        const isActive = state.activeConversationId === group.id;
                         const el = document.createElement('button');
                        el.className = `w-full text-left p-3 rounded-lg flex items-center gap-3 hover:bg-gray-100 transition ${isActive ? 'bg-blue-50 ring-1 ring-blue-200' : ''}`;
                        el.onclick = () => this.openChat(group.id, 'GROUP');
                        
                        el.innerHTML = `
                             <div class="w-10 h-10 rounded-full bg-indigo-500 text-white flex items-center justify-center font-bold">#</div>
                            <div class="flex-1">
                                <div class="font-semibold text-gray-800">${group.name}</div>
                                <div class="text-xs text-gray-500 truncate">${group.participants.length} members</div>
                            </div>
                        `;
                        container.appendChild(el);
                    });
                }
            }

            openChat(id, type) {
                state.activeConversationId = id;
                this.renderSidebar(); // Update active state highlight

                const input = document.getElementById('message-input');
                const btn = document.getElementById('send-btn');
                input.disabled = false;
                btn.disabled = false;
                input.focus();

                let title, avatarContent, avatarClass;
                
                if (type === 'DIRECT') {
                    const user = USERS[id];
                    title = user.name;
                    avatarContent = user.name[0];
                    avatarClass = user.avatarBg;
                    this.updateHeaderStatus(id);
                } else {
                    const group = GROUPS[id];
                    title = group.name;
                    avatarContent = '#';
                    avatarClass = 'bg-indigo-500';
                    document.getElementById('header-status').innerText = `${group.participants.map(uid => USERS[uid].name).join(', ')}`;
                }

                document.getElementById('header-title').innerText = title;
                const avatar = document.getElementById('header-avatar');
                avatar.innerText = avatarContent;
                avatar.className = `w-10 h-10 rounded-full flex items-center justify-center font-bold text-white ${avatarClass}`;

                this.renderMessages(id);
            }

            updateHeaderStatus(userId) {
                const isOnline = state.presence[userId] === 'ONLINE';
                const el = document.getElementById('header-status');
                el.innerHTML = isOnline 
                    ? '<span class="text-green-600 font-semibold">Online</span>' 
                    : '<span class="text-gray-400">Offline</span>';
            }

            renderMessages(conversationId) {
                const container = document.getElementById('messages-container');
                container.innerHTML = '';
                
                const msgs = state.messages[conversationId] || [];
                
                if (msgs.length === 0) {
                     container.innerHTML = `
                         <div class="h-full flex flex-col items-center justify-center text-gray-400 opacity-50">
                            <p>No messages yet. Say hi!</p>
                        </div>
                     `;
                     return;
                }

                msgs.forEach(msg => {
                    const isMe = msg.senderId === state.currentUser.id;
                    const sender = USERS[msg.senderId];
                    
                    const msgDiv = document.createElement('div');
                    msgDiv.className = `flex ${isMe ? 'justify-end' : 'justify-start'} mb-4`;
                    
                    msgDiv.innerHTML = `
                        <div class="flex max-w-[70%] ${isMe ? 'flex-row-reverse' : 'flex-row'} items-end gap-2">
                             ${!isMe ? `<div class="w-6 h-6 rounded-full ${sender.avatarBg} text-white text-xs flex items-center justify-center flex-shrink-0 mb-1" title="${sender.name}">${sender.name[0]}</div>` : ''}
                            <div class="
                                py-2 px-4 rounded-2xl text-sm shadow-sm
                                ${isMe ? 'bg-blue-600 text-white rounded-br-none' : 'bg-white border border-gray-200 text-gray-800 rounded-bl-none'}
                            ">
                                <p>${msg.content}</p>
                                <div class="text-[10px] mt-1 opacity-70 ${isMe ? 'text-blue-100' : 'text-gray-400'} text-right">
                                    ${msg.time}
                                    ${isMe ? '<span class="ml-1">âœ“</span>' : ''}
                                </div>
                            </div>
                        </div>
                    `;
                    container.appendChild(msgDiv);
                });

                container.scrollTop = container.scrollHeight;
            }

            sendMessage(e) {
                e.preventDefault();
                const input = document.getElementById('message-input');
                const content = input.value.trim();
                if (!content) return;

                const convId = state.activeConversationId;
                const now = new Date();
                const timeString = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');

                // Create Message Object
                const msg = {
                    id: Date.now().toString(),
                    senderId: state.currentUser.id,
                    content: content,
                    time: timeString
                };

                // Add to State
                if (!state.messages[convId]) state.messages[convId] = [];
                state.messages[convId].push(msg);

                // Clear Input
                input.value = '';

                // Render
                this.renderMessages(convId);

                // Log "API Call"
                console.log(`[API] POST /chat/message -> Payload:`, msg);

                // Simulate Receive from other (Echo bot for direct message)
                if (GROUPS[convId]) {
                    // It's a group, maybe someone replies?
                    this.simulateReply(convId);
                } else {
                    // Direct message, the other person replies
                    this.simulateReply(convId, convId); // convId in direct is the userId of the other person
                }
            }

            simulateReply(conversationId, specificSenderId = null) {
                setTimeout(() => {
                    let senderId = specificSenderId;
                    
                    if (!senderId) {
                        // Pick random participant in group who is not me
                        const group = GROUPS[conversationId];
                        const others = group.participants.filter(pid => pid !== state.currentUser.id);
                        senderId = others[Math.floor(Math.random() * others.length)];
                    }

                    const sender = USERS[senderId];
                    if (!sender) return; // Should not happen

                    const now = new Date();
                    const timeString = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');

                    const replyMsg = {
                        id: Date.now().toString(),
                        senderId: senderId,
                        content: `This is a simulated reply from ${sender.name}.`,
                        time: timeString
                    };

                    if (!state.messages[conversationId]) state.messages[conversationId] = [];
                    state.messages[conversationId].push(replyMsg);
                    
                    console.log(`[WS] Event: NEW_MESSAGE from ${sender.name}`, replyMsg);
                    
                    // Only update UI if we are looking at this conversation
                    if (state.activeConversationId === conversationId) {
                        this.renderMessages(conversationId);
                    } else {
                        // Could show a badge or notification here
                        this.showToast(`New message from ${sender.name}`);
                    }

                }, 2000 + Math.random() * 2000); // 2-4 seconds delay
            }

            showToast(message) {
                const toast = document.getElementById('toast');
                toast.innerText = message;
                toast.classList.remove('translate-y-[-150%]', 'opacity-0');
                
                setTimeout(() => {
                    toast.classList.add('translate-y-[-150%]', 'opacity-0');
                }, 3000);
            }
        }

        // Initialize
        const app = new App();

        // Helper simulation of initial "network"
        console.log('App Loaded. Waiting for user login...');

    </script>
</body>
</html>
